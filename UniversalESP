--//Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LogService = game:GetService("LogService")

--//Libraries
local OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"), true)()

--//Variables
local LocalPlayer = Players.LocalPlayer
local mt = getrawmetatable(game)

--//Controls
local old = mt.__namecall
local characterFolder = nil
local highlight = nil
local highlightYourself = false
local rainbowESP = false
local highlightColor = nil
local fillTransparency = 0.5

--//Tables
local Connections = {}

--//Initialization
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
	local method = getnamecallmethod()

	if method == "Kick" then
		return
	end

	return old(self, ...)
end)

setreadonly(mt, true)

OrionLib:MakeNotification({
	Name = "Universal ESP is loading...",
	Content = "Welcome ".. LocalPlayer.Name ..".\n\nScripted by Katrist#3130",
	Image = "rbxassetid://4483345998",
	Time = 5
})

local Window = OrionLib:MakeWindow({
	Name = "Universal ESP", 
	HidePremium = false, 
	SaveConfig = true, 
	ConfigFolder = "ESPConfiguration"
})

local ESP = Window:MakeTab({
	Name = "ESP",
	Icon = "rbxassetid://4483345998",
	PremiumOnly = false
})

ESP:AddToggle({
	Name = "ESP",
	Default = false,
	Save = true,
	Flag = "ESP",
	Callback = function(Bool)
		if Bool then
			characterFolder = Instance.new("Model")
			characterFolder.Name = HttpService:GenerateGUID(false)

			highlight = Instance.new("Highlight")
			highlight.Adornee = characterFolder
			highlight.Name = HttpService:GenerateGUID(false)
			highlight.FillColor = highlightColor
			highlight.OutlineColor = highlightColor
			highlight.FillTransparency = fillTransparency
			highlight.Parent = gethui()

			characterFolder.Parent = workspace

			for i, player: Player in ipairs(Players:GetPlayers()) do
				if player == LocalPlayer and not highlightYourself then
					continue
				end

				if player.Character then
					local Humanoid = player.Character.Humanoid
					Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.Subject
					Humanoid.NameDisplayDistance = math.huge
					Humanoid.NameOcclusion = Enum.NameOcclusion.NoOcclusion

					player.Character.Parent = characterFolder
				end

				Connections[player] = player.CharacterAdded:Connect(function(character)
					local Humanoid = character:WaitForChild("Humanoid")
					Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.Subject
					Humanoid.NameDisplayDistance = math.huge
					Humanoid.NameOcclusion = Enum.NameOcclusion.NoOcclusion

					character.Parent = characterFolder
				end)
			end

			Connections["PlayerAdded"] = Players.PlayerAdded:Connect(function(player)
				Connections[player] = player.CharacterAdded:Connect(function(character)
					local Humanoid = character:WaitForChild("Humanoid")
					Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.Subject
					Humanoid.NameDisplayDistance = math.huge
					Humanoid.NameOcclusion = Enum.NameOcclusion.NoOcclusion

					character.Parent = characterFolder
				end)
			end)
		else
			for i, connection: RBXScriptConnection in ipairs(Connections) do
				connection:Disconnect()
			end

			if characterFolder then
				for i, character in ipairs(characterFolder:GetChildren()) do
					local Humanoid = character.Humanoid
					Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.Viewer
					Humanoid.NameDisplayDistance = 100
					Humanoid.NameOcclusion = Enum.NameOcclusion.OccludeAll

					character.Parent = workspace
				end
				
				if highlight then
					highlight:Destroy()
					highlight = nil
				end
				
				characterFolder:Destroy()
				characterFolder = nil
			end
		end
	end    
})

ESP:AddToggle({
	Name = "Highlight Yourself",
	Default = false,
	Save = true,
	Flag = "HighlightYourself",
	Callback = function(Bool)
		highlightYourself = Bool

		if highlightYourself then
			if characterFolder then
				if LocalPlayer.Character then			
					LocalPlayer.Character.Parent = characterFolder
				end

				Connections[LocalPlayer] = LocalPlayer.CharacterAdded:Connect(function(character)
					character.Parent = characterFolder
				end)
			end
		else
			local connection = Connections[LocalPlayer]

			if connection then
				connection:Disconnect()
			end

			if LocalPlayer.Character then
				LocalPlayer.Character.Parent = workspace
			end
		end
	end    
})

ESP:AddToggle({
	Name = "Rainbow ESP",
	Default = false,
	Save = true,
	Flag = "RainbowESP",
	Callback = function(Bool)
		rainbowESP = Bool

		if rainbowESP then
			local ESPColor = OrionLib.Flags["ESPColor"]
			local hue, saturation, value = highlightColor:ToHSV()

			while rainbowESP do
				ESPColor:Set(Color3.fromHSV(hue, 1, 1))
				hue += 1/100

				task.wait(0.05)

				if hue >= 1 then
					hue = 0
				end
			end
		end
	end    
})

ESP:AddColorpicker({
	Name = "ESP Color",
	Default = Color3.fromRGB(255, 255, 255),
	Save = true,
	Flag = "ESPColor",
	Callback = function(color)
		highlightColor = color

		if characterFolder and highlight then
			highlight.FillColor = highlightColor
			highlight.OutlineColor = highlightColor
		end
	end
})

ESP:AddSlider({
	Name = "Fill Transparency",
	Min = 0,
	Max = 100,
	Default = 50,
	Save = true,
	Flag = "FillTransparency",
	Color = Color3.fromRGB(141, 141, 141),
	Increment = 10,
	ValueName = "%",
	Callback = function(number)
		fillTransparency = number / 100

		if characterFolder and highlight then
			highlight.FillTransparency = fillTransparency
		end
	end    
})


local Credits = Window:MakeTab({
	Name = "Credits",
	Icon = "rbxassetid://4483345998",
	PremiumOnly = false
})

Credits:AddParagraph("Katrist#3130",
	"Scripter of the ESP"
)

Credits:AddParagraph("shlex#0001",
	"Designed and scripted Orion"
)

OrionLib:Init()
